name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      id: changelog
      run: |
        # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          # åˆå›ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã¯å…¨ã‚³ãƒŸãƒƒãƒˆã‚’å«ã‚ã‚‹
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          # å‰å›ã®ã‚¿ã‚°ã‹ã‚‰ç¾åœ¨ã¾ã§ã®å¤‰æ›´ã‚’å–å¾—
          CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œ
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release Archive
      run: |
        mkdir -p release-assets
        
        # ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
        zip -r release-assets/vmware-report-${{ steps.get_version.outputs.version_number }}.zip \
          vmware-report.ps1 \
          modules/ \
          config/*.json \
          LICENSE \
          README.md \
          -x "*.git*" \
          -x "*node_modules*" \
          -x "*.DS_Store"
        
        # SHA256ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’ç”Ÿæˆ
        cd release-assets
        sha256sum vmware-report-${{ steps.get_version.outputs.version_number }}.zip > checksums.txt
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## VMware Report Generator ${{ steps.get_version.outputs.version }}
          
          ### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          
          1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å±•é–‹
          3. PowerShellã§å®Ÿè¡Œ:
             ```powershell
             ./vmware-report.ps1
             ```
          
          ### ğŸ“‹ å¿…è¦è¦ä»¶
          
          - PowerShell 5.1 ä»¥ä¸Š
          - VMware PowerCLI ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
          - vCenter Server ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™
          
          ### ğŸ“ å¤‰æ›´å†…å®¹
          
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸ” ãƒã‚§ãƒƒã‚¯ã‚µãƒ  (SHA256)
          
          ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
          ```
          sha256sum vmware-report-${{ steps.get_version.outputs.version_number }}.zip
          ```
          
          è©³ç´°ã¯ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) ã‚’ã”è¦§ãã ã•ã„ã€‚
        draft: false
        prerelease: false
        files: |
          release-assets/vmware-report-${{ steps.get_version.outputs.version_number }}.zip
          release-assets/checksums.txt
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify release completion
      if: success()
      run: |
        echo "âœ… Release ${{ steps.get_version.outputs.version }} has been created successfully!"
        echo "ğŸ“¦ Download: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"
